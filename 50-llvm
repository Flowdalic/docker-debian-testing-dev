#!/usr/bin/env bash
set -euo pipefail

source config

declare -ir LLVM_VERSION=12

cat <<EOF > /etc/apt/sources.list.d/llvm.list
deb http://apt.llvm.org/bullseye/ llvm-toolchain-bullseye-${LLVM_VERSION} main
deb-src http://apt.llvm.org/bullseye/ llvm-toolchain-bullseye-${LLVM_VERSION} main
EOF

wget -O - https://apt.llvm.org/llvm-snapshot.gpg.key | apt-key add -

apt-get update

readarray LLVM_PACKAGES <<EOF
clang-${LLVM_VERSION}
clang-format-${LLVM_VERSION}
clang-tidy-${LLVM_VERSION}
clang-tools-${LLVM_VERSION}
clangd-${LLVM_VERSION}
libc++-${LLVM_VERSION}-dev
libc++abi-${LLVM_VERSION}-dev
libclang-${LLVM_VERSION}-dev
libclang-common-${LLVM_VERSION}-dev
libclang1-${LLVM_VERSION}
libclc-${LLVM_VERSION}
libfuzzer-${LLVM_VERSION}-dev
libllvm-${LLVM_VERSION}-ocaml-dev
libllvm${LLVM_VERSION}
libomp-${LLVM_VERSION}-dev
lld-${LLVM_VERSION}
lldb-${LLVM_VERSION}
llvm-${LLVM_VERSION}
llvm-${LLVM_VERSION}-dev
llvm-${LLVM_VERSION}-examples
llvm-${LLVM_VERSION}-runtime
python3-clang-${LLVM_VERSION}
EOF

apt-get ${APT_INSTALL} ${LLVM_PACKAGES[@]}

# Make libomp findable via e.g. Meson's find_library()
ln -s "/usr/lib/llvm-${LLVM_VERSION}/lib/libomp.so" /usr/lib
